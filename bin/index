#!/bin/sh

# set -Eeuo pipefail


start() {
    echo "starting index server ..."
    set -x
    mkdir -p var/log
    rm -f var/log/index.log 
    INDEX_PATH="inverted_index_0.txt" flask --app index run --host 0.0.0.0 --port 9000 >> var/log/index.log 2>&1 &
    INDEX_PATH="inverted_index_1.txt" flask --app index run --host 0.0.0.0 --port 9001 >> var/log/index.log 2>&1 &
    INDEX_PATH="inverted_index_2.txt" flask --app index run --host 0.0.0.0 --port 9002 >> var/log/index.log 2>&1 &
}

stop() {
    echo "stopping index server ..."
    set -x
    pkill -f "flask --app index run --host 0.0.0.0 --port 9000" || true
    pkill -f "flask --app index run --host 0.0.0.0 --port 9001" || true
    pkill -f "flask --app index run --host 0.0.0.0 --port 9002" || true
}

case $1 in
    "start")
        start
        ;;
    "stop")
        stop
        ;;
    "restart")
        stop
        start
        ;;
    *)
        exit 1
        ;;
esac